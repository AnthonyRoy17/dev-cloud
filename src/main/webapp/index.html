<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
<meta http-equiv="content-type"
	content="application/xhtml+xml; charset=UTF-8" />
<meta name="google-signin-client_id"
	content="927375242383-t21v9ml38tkh2pr30m4hqiflkl3jfohl.apps.googleusercontent.com">

<!-- Latest compiled and minified CSS -->
<link rel="stylesheet"
	href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

<!-- jQuery library -->
<script
	src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<!-- Popper JS -->
<script
	src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>

<!-- Latest compiled JavaScript -->
<script
	src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/bulma@0.8.0/css/bulma.min.css">


<script defer
	src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>
<script src="https://unpkg.com/mithril/mithril.js"></script>

<script src="https://apis.google.com/js/api:client.js"></script>

<script src="https://cdn.jsdelivr.net/npm/vue@2.6.0"></script>


<title>Hello App Engine</title>


</head>


<nav class="navbar navbar-expand-lg navbar-light bg-light">
	<a class="navbar-brand"  onclick="Petition.allPetition()" href="#">Site de Petition</a>
	<button class="navbar-toggler" type="button" data-toggle="collapse"
		data-target="#navbarSupportedContent"
		aria-controls="navbarSupportedContent" aria-expanded="false"
		aria-label="Toggle navigation">
		<span class="navbar-toggler-icon"></span>
	</button>

	<div class="collapse navbar-collapse" id="navbarSupportedContent">
		<ul class="navbar-nav mr-auto">
			<li class="nav-item active"><a class="nav-link" href="/">
				<span class="sr-only">(current)</span></a>
			</li>
			<li class="nav-item"><a class="nav-link"  href="/#!/top/">Meilleures petitions</a>
			</li>
			<li class="nav-item"><a class="nav-link"  href="/#!/votebyuser">Petition votées d'un utilisateur</a>
			</li>
			<li class="nav-item"><a class="nav-link"  href="/#!/petitionbyname">Petition par nom</a></li>
			<li class="nav-item"><a class="nav-link g-signin2" data-onsuccess = "connexion" href="#">Se connecter</a></li>
		</ul>
	</div>
</nav>
<body>

	<!-- 
	<form method="post">
		<div>
			<label for="name">Nom :</label> <input type="text" id="name"
				name="petition_name">
		</div>
		<div>
			<label for="description">Description:</label> <input type="text"
				id="description" name="petition_description">
		</div>
		<div class="button">
			<button type="submit" onclick="Petition.addPetition()">Creer
				la pétition</button>
		</div>
	</form>
	 -->

	<div class="container" id ="result">
	
	
	</div>



<script>

	
		var extractStatus = function(xhr, xhrOptions) {
		  return xhr.status != 200 ? xhr.status : xhr.responseText
		}
	
	 	function showmessage(){
	    	console.log("debut message");
	    	 return m.request({
		            method: "GET",
		            url: "_ah/api/myApi/v1/showmessage",
		            extract: extractStatus
		     })
		     .then(function(result) {
		            var message  = result;
		        	console.log("message :",message)
		        	// m.redraw(true) 
		        })
	    }
	 	
	 	var Petition = {
	 			
	 			current :{
	 				"id":"",
	 				"key":"",
	 				"name":"",
	 				"body":"",
	 				"date":"",
	 				"nbvotants":"",
	 				"votants":[],
	  		    	
	 			},
	 			
	 			
	  	    	addPetition : function(){
	  	    		var mail =  encodeURIComponent(User.userInformation.mail);
	  	    		var name = document.getElementById("name").value;
	  	    		var desc = document.getElementById("description").value;
			        return m.request({
			            method: "POST",
			            url: "_ah/api/myApi/v1/addpetition/"+name+"/"+desc+"/"+mail,
			        })
			        .then(function(result) {
			        	console.log("message : ça marche")
			        	// m.redraw(true) 
			        })
	  	    	},
	  	    	listAllPetition: [],
			 	allPetition : function(){
			 		console.log("dans all petition");
			        return m.request({
			            method: "GET",
			            url: "_ah/api/myApi/v1/allPetition",
			        })
			        .then(function(result) {
			        	Petition.listAllPetition = result.items
			        	m.redraw(true)
	     			})
			 	},
			 	
			 	listPetitionVotedByUser: [],
			 	petitionVotedByUser : function(){	
			 		this.list = [];
			 		var name = document.getElementById("nom_user").value;
			 	    console.log("dans petitionUser" + name);
			 	    if(name != null){
			 	    	return m.request({
				            method: "GET",
				            url: "_ah/api/myApi/v1/petitionVotedByUser/"+name,
				        })
				        .then(function(result) {
				        	Petition.listPetitionVotedByUser = result.items
				        	m.redraw(true)
		     			})
			 	    }
			 		
			 	},	
			 	
			 	listPetitionByName: [],
			 	petitionByName : function(name){
			 		return m.request({
			            method: "GET",
			            url: "_ah/api/myApi/v1/petitionByName/"+name,
			        })
			        .then(function(result) {
			        	Petition.listPetitionByName = result.items
			        	m.redraw(true)
	     			})
			 	},	
			 	listBestPetition: [],
			 	BestPetition : function(page){
			 		console.log('Bestpetition')
			 		return m.request({
			            method: "GET",
			            url: "_ah/api/myApi/v1/BestPetition/",
			            
			        })
			        .then(function(result) {
			        	Petition.listBestPetition = result.items
			        	m.redraw(true)
	     			})
			 	},	
			 	
			 	detailPetition : function(key){
			 		console.log("dans detail petition")
			 		return m.request({
			            method: "GET",
			            url: "_ah/api/myApi/v1/detailPetition/"+key,
			            
			            
			        })
			        .then(function(result) {
			        	
			        	if (result != null){
			        		Petition.current.id = result.key.id,
			        		Petition.current.key = result.properties.Key,
				        	Petition.current.name = result.properties.Name,
				        	Petition.current.body = result.properties.Body,
				        	Petition.current.date = result.properties.Date,
				        	Petition.current.nbvotants = result.properties.nbvotants,
				        	Petition.current.votants = result.properties.votants
			        	}
	     			})
			 	},
			 	
			 	votePetition : function(key){
			 		console.log("dans vote petition")
			 		return m.request({
			            method: "POST",
			            url: "_ah/api/myApi/v1/votePetition/"+key+"/"+User.userInformation.mail,
			            
			            
			        })
			        .then(function(result) {
			        	
			        	
	     			})
			 	}	
	  	    }
	 		
			var VueAllPetition = {
	 			oninit : Petition.allPetition(),
				view: function() {
					
				   	return m('div', [
						m('div',{class:'subtitle'},"Liste petition de la plus récente à la plus ancienne"),
						m('table', {class:'table is-striped'},[
					 		m('tr', [
									m('th', {width:"20px"}, "Name"),
									m('th', {width:"20px"}, "Body"),
									m('th', {width:"50px"}, "Date"),
									
						    ]),
						    
						    Petition.listAllPetition.map(function(item) {
						    	console.log(item)
								return m("tr", [
									m('td', m('label', item.properties.Name)),
									m('td', m('label', item.properties.Body)),
									m('td', m('label', item.properties.Date)),
									m('a', {'class':'nav-link','href':'#!/detailpetition/'+item.properties.Key}, 
											'Voir'
									)
								 	
								])
						    })
						]),
						
					 ])
				  } 
			}
	 	
	 	
		 	var VuelistPetitionVotedByUser = {
					view: function() {
					   	return m('div', [
							m('div',{class:'subtitle'},"Liste Petition signé par un utilisateur"),
							
							m('div',
									  [
									    m('label', {'for':'name'}, 
									      'Nom :'
									    ),
									    m('input', {'type':'text','id':'nom_user','name':'petition_name'})
									  ]
							),
							m('div', {'class':'button'}, 
									  m('button', { onclick: function(e) {Petition.petitionVotedByUser()}},
									    'Rechercher'
									  )
							),
							m('table', {class:'table is-striped'},[
						 		m('tr', [
										m('th', {width:"20px"}, "Name"),
										m('th', {width:"20px"}, "Body"),
										m('th', {width:"50px"}, "Date"),
										
							    ]),
							    
							    Petition.listPetitionVotedByUser.map(function(item) {
									return m("tr", [
										m('td', m('label', item.properties.Name)),
										m('td', m('label', item.properties.Body)),
										m('td', m('label', item.properties.Date)),
										m('a', {'class':'nav-link','href':'#!/detailpetition/'+item.properties.Key}, 
												'Voir'
										)
									])
							    })
							]),
							
						 ])
					  } 
			}
	 		
	 
		 	var VuePetition = {
					view: function() {
						
					   	return m('div', [
							m('div',{class:'subtitle'},"Recherche par nom"),
							
							m('div',
									  [
									    m('label', {'for':'name'}, 
									      'Nom :'
									    ),
									    m('input', {'type':'text','id':'nom_petition','name':'petition_name'})
									  ]
							),
							m('div', {'class':'button'}, 
									  m('button', { onclick: function(e) {Petition.petitionByName(document.getElementById("nom_petition").value)}},
									    'Rechercher'
									  )
							),
							m('table', {class:'table is-striped'},[
						 		m('tr', [
										m('th', {width:"20px"}, "Name"),
										m('th', {width:"20px"}, "Body"),
										m('th', {width:"50px"}, "Date"),
										
							    ]),
							    
							    Petition.listPetitionByName.map(function(item) {
									return m("tr", [
										m('td', m('label', item.properties.Name)),
										m('td', m('label', item.properties.Body)),
										m('td', m('label', item.properties.Date)),
										m('a', {'class':'nav-link','href':'#!/detailpetition/'+item.properties.Key}, 
												'Voir'
										)
									 	
									])
							    })
							]),
							m('button',{
								class: 'button is-link',
								onclick: function(e) {}
						    	},
						    "Voir plus"),
							
						 ])
					  } 
			}
	 	
	 	
		 	var VueBestPetition = {
	 				controller : function(){
		 			    this.index  = 0 
	 			  	},
	 				
		 			oninit: function(vnode){
		 				console.log(vnode)
		 				Petition.BestPetition(vnode.attrs.index)
		 				
		 			},
					view: function(ctrl) {
						console.log(ctrl.attrs.index)
					   	return 	m('div', [
							m('div',{class:'subtitle'},"Liste des meilleures Petitions"),
							m('table', {class:'table is-striped'},[
						 		m('tr', [
						 				m('th', {width:"20px"}, "key"),
										m('th', {width:"20px"}, "Name"),
										m('th', {width:"20px"}, "Body"),
										m('th', {width:"50px"}, "Date"),
										m('th', {width:"50px"}, "Nb Vote"),
										
							    ]),
							    
							    Petition.listBestPetition.map(function(item) {
									return m("tr", [
										m('td', m('label', item.properties.Key)),
										m('td', m('label', item.properties.Name)),
										m('td', m('label', item.properties.Body)),
										m('td', m('label', item.properties.Date)),
										m('td', m('label', item.properties.nbvotants)),
										m('div', {'class':'button'}, 
										m('a', {'class':'nav-link','href':'#!/detailpetition/'+item.properties.Key}, 
											'Voir'
										)),
									])
							    })
							]),
							m('a', {'class':'button ',
								onclick   : function(){
						              ctrl.attrs.index++
						              
								},
								'href':'#!/BestPetition/'+ctrl.attrs.index
								}, 
								'voir plus'
							),
							
						 ])
					  } 
			}
	 	
		 	var VueDetailPetition = {
	 				oninit: function(vnode){ 
	 					console.log(vnode)
						Petition.detailPetition(vnode.attrs.key);
	 				},
					view: function() {
					   	return 	m('div', [
							m('div',{class:'subtitle'},"vue detail d'une petition"),
							m('a', {'class':'nav-link','href':'#!/vote/'+Petition.current.key}, 
									'Voter pour cette petition'
							),
							m('table', {class:'table is-striped'},[
						 		m('tr', [
										m('th', {width:"20px"}, "Name"),
										m('th', {width:"20px"}, "votants"),
										m('th', {width:"50px"}, "Date"),
										m('th', {width:"50px"}, "Nb Vote"),
										
							    ]),
							    	
								 m("tr", [
									m('td', m('label', Petition.current.name)),
									//m('td', m('label', item.properties.Body)),
									//m('td', m('label', item.properties.Date)),
									//m('td', m('label', item.properties.nbvotants)),
									
									Petition.current.votants.map(function(votants) {
									return m("tr", [
										m('td', m('label', votants)),
										
										])
									
						    		}),
						    		m('td', m('label', Petition.current.date)),
									m('td', m('label', Petition.current.nbvotants)),
								 	
								])
							   
							]),
						 ])
					  } 
			}
	 	
	 	
	 
		var elem = 	document.getElementById("result");
	 	//m.mount(elem, VueBestPetition)	
	 	//m.mount(elem, VueBestPetition)
	 	//m.mount(elem2, VueBestPetition)	
	 	
	 
  		
	 	m.route(elem, "/", {

	   		 '/': VueAllPetition,
	   		 '/top/': VueBestPetition,
	   		 '/votebyuser': VuelistPetitionVotedByUser,
	   		 '/petitionbyname/': VuePetition,
	   		 '/detailpetition/:key': VueDetailPetition,
		})
		
	 	
	 	
	 	
  
  		var User = {
  				userInformation: {
  						"ID" : "",
  						"nom" : "",
  						"mail" : ""
  				}
  		}
  		
  		
  		
  		
  		function connexion(googleUser){
  				User.userInformation.ID = googleUser.getBasicProfile().getId()
  				User.userInformation.nom = googleUser.getBasicProfile().getName()
  				User.userInformation.mail = googleUser.getBasicProfile().getEmail()
  				console.log(User)
  		}
  		
  		function onSuccess(googleUser) {
  	      console.log('Logged in as: ' + googleUser.getBasicProfile().getName());
  	    }
  	    function onFailure(error) {
  	      console.log(error); 
  	    }
  	    
  	    
  	    
  	    
  
</script>
</body>
<script src="https://apis.google.com/js/platform.js?onload=renderButton"
	async defer></script>

</html>